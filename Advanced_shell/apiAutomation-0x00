#!/bin/bash

# API Request Automation Script
# Fetches Pikachu data from the PokÃ©mon API and saves it to data.json
# Logs any errors to errors.txt

# Configuration
POKEMON_NAME="pikachu"
API_URL="https://pokeapi.co/api/v2/pokemon/${POKEMON_NAME}"
OUTPUT_FILE="data.json"
ERROR_FILE="errors.txt"

# Make API request and save response
# -s: silent mode (no progress bar)
# -S: show errors even in silent mode
# -w "%{http_code}": write HTTP status code to stdout
# -o: output file for response body
HTTP_CODE=$(curl -s -S -w "%{http_code}" -o "${OUTPUT_FILE}" "${API_URL}" 2>"${ERROR_FILE}.tmp")

# Check if curl command was successful
if [ $? -ne 0 ]; then
    echo "Error: Failed to make API request" >> "${ERROR_FILE}"
    cat "${ERROR_FILE}.tmp" >> "${ERROR_FILE}"
    rm -f "${ERROR_FILE}.tmp"
    rm -f "${OUTPUT_FILE}"
    exit 1
fi

# Check HTTP status code
if [ "${HTTP_CODE}" -ne 200 ]; then
    echo "Error: API request failed with HTTP status code ${HTTP_CODE}" >> "${ERROR_FILE}"
    if [ -f "${ERROR_FILE}.tmp" ]; then
        cat "${ERROR_FILE}.tmp" >> "${ERROR_FILE}"
    fi
    rm -f "${ERROR_FILE}.tmp"
    rm -f "${OUTPUT_FILE}"
    exit 1
fi

# Clean up temporary error file if request was successful
rm -f "${ERROR_FILE}.tmp"

echo "Successfully fetched data for ${POKEMON_NAME} and saved to ${OUTPUT_FILE}"
exit 0
